#!/usr/bin/env bash

# Args:
# -c         save to icloud
# -t         append a timestamp
# -s suffix  append a suffix
# -d dir     save to directory
#
# Note: -s takes precedence over -t if both are specified

USAGE="Usage: ${0##*/} [-c] [-t] [-s <suffix>] [-d <dest-dir>] <files-to-save>"

while getopts ":cts:d:" opt; do
  case "$opt" in
    c) SAVEDIR="save-icloud" ;;
    t) TIMESTAMP=",$(date +%H%M)" ;;
    s) SUFFIX=",${OPTARG}" ;;
    d) DESTDIR="${OPTARG}" ;;
    :) echo "Option -$OPTARG requires an argument" >&2; echo "$USAGE" >&2; exit 1 ;;
    \?) echo "Invalid option: -$OPTARG" >&2; echo "$USAGE" >&2; exit 1 ;;
  esac
done
shift $((OPTIND - 1))

if (($# < 1)); then
  echo "$USAGE" >&2
  exit 3
fi

: "${SAVEDIR:=save}"
: "${DESTDIR:=$(date +%y%m%d)}"

dest_root="$HOME/$SAVEDIR/$DESTDIR"
mkdir -p "$dest_root" || exit 4

# set suffix to append to saved file/directory
[[ -z $SUFFIX && -n $TIMESTAMP ]] && SUFFIX="$TIMESTAMP"

# debug
# printf 'Args:\n'; printf '  %q\n' "$@"

for src in "$@"; do
  base=$(basename "$src")

  [[ $base = .* ]] && base="_${base#.}"

  dest_path="$dest_root/${base}${SUFFIX}"

  if [[ -f $src ]]; then
    cp -i -- "$src" "$dest_path" && echo "$dest_path"
  elif [[ -d $src ]]; then
    cp -iR -- "$src" "$dest_path" && echo "$dest_path"
  else
    echo "ERROR: $src does not exist" >&2
  fi
done

